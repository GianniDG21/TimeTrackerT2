name: Build macOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Debug - Check project structure
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== Root contents ==="
        ls -la
        echo "=== Scripts directory ==="
        ls -la scripts/ 2>/dev/null || echo "No scripts directory"
        echo "=== Python version ==="
        python --version
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter pygame pyinstaller pillow
        echo "=== Installed packages ==="
        pip list | grep -E "(customtkinter|pygame|pyinstaller)"
        
    - name: Create missing files
      run: |
        echo "=== Creating missing JSON files ==="
        echo '[]' > subjects.json
        echo '[]' > sessions.json
        echo '{}' > user_config.json
        echo '[]' > goals.json
        echo '{}' > progress_notes.json
        echo "Files created successfully"
        ls -la *.json
        
    - name: Simple PyInstaller build
      run: |
        echo "=== Starting simple build ==="
        mkdir -p release
        python -m PyInstaller \
          --onefile \
          --windowed \
          --name=TimeTrackerT2_v2.0 \
          --distpath=release \
          --add-data="subjects.json:." \
          --add-data="sessions.json:." \
          --hidden-import=customtkinter \
          --hidden-import=pygame \
          --collect-all=customtkinter \
          main_gui.py
        
    - name: Verify build output
      run: |
        echo "=== Contents of release directory ==="
        ls -la release/ || echo "No release directory found"
        
        if [ -f "release/TimeTrackerT2_v2.0" ]; then
          echo "✅ macOS executable created successfully"
          du -sh release/TimeTrackerT2_v2.0
          file release/TimeTrackerT2_v2.0
        else
          echo "❌ macOS executable not found"
          ls -la release/ 2>/dev/null || echo "Release directory empty"
        fi
        
    - name: Upload macOS Executable  
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: TimeTrackerT2-macOS-Executable
        path: release/TimeTrackerT2_v2.0
        if-no-files-found: error
        
    - name: Create Release (on tag)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/TimeTrackerT2_v2.0
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}