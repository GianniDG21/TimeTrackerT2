name: Build macOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install customtkinter pygame pyinstaller
        
    - name: Create required files
      run: |
        python3 -c "
        import json
        # Create sessions.json
        with open('sessions.json', 'w') as f:
            json.dump([], f)
        # Create subjects.json  
        with open('subjects.json', 'w') as f:
            json.dump({'Demo': ['Python', 'JavaScript', 'React']}, f)
        # Create users.txt
        with open('users.txt', 'w') as f:
            f.write('Demo User\n')
        print('Files created successfully')
        "
        
    - name: Build macOS App Bundle
      run: |
        pyinstaller \
          --onedir \
          --windowed \
          --name="TimeTrackerT2_v2.0" \
          --distpath=dist \
          --add-data="subjects.json:." \
          --add-data="sessions.json:." \
          --add-data="users.txt:." \
          --hidden-import=customtkinter \
          --hidden-import=pygame \
          --hidden-import=tkinter \
          --hidden-import=PIL \
          --collect-all=customtkinter \
          --osx-bundle-identifier=com.timetracker.v2 \
          main_gui.py
          
    - name: Set proper permissions
      run: |
        chmod -R 755 dist/TimeTrackerT2_v2.0.app
        chmod +x dist/TimeTrackerT2_v2.0.app/Contents/MacOS/TimeTrackerT2_v2.0
        
    - name: Verify app bundle
      run: |
        echo "=== App Bundle Structure ==="
        ls -la dist/
        echo "=== App Contents ==="
        ls -la dist/TimeTrackerT2_v2.0.app/Contents/
        echo "=== MacOS Executable ==="
        ls -la dist/TimeTrackerT2_v2.0.app/Contents/MacOS/
        
    - name: Create proper app bundle archive
      run: |
        cd dist
        tar -czf TimeTrackerT2_v2.0_macOS.tar.gz TimeTrackerT2_v2.0.app
        
    - name: Create DMG
      run: |
        mkdir -p dmg_temp
        cp -R dist/TimeTrackerT2_v2.0.app dmg_temp/
        ln -s /Applications dmg_temp/Applications
        hdiutil create -volname "TimeTrackerT2 v2.0" -srcfolder dmg_temp -ov -format UDZO dist/TimeTrackerT2_v2.0.dmg
        
    - name: Upload App Bundle (TAR Archive)
      uses: actions/upload-artifact@v4
      with:
        name: TimeTrackerT2-macOS-TAR
        path: dist/TimeTrackerT2_v2.0_macOS.tar.gz
        
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: TimeTrackerT2-macOS-DMG
        path: dist/TimeTrackerT2_v2.0.dmg